<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF Site & Route Map</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- LeafletJS for the interactive map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
        }
        #map { 
            height: 100vh; 
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #111827; /* gray-900 */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        /* Numbered route markers */
        .route-marker-icon {
            background-color: #ffffff;
            border: 2px solid #111827; /* gray-900 */
            color: #111827;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* UI Panel transitions */
        .view-panel {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .view-panel.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            position: absolute;
            width: calc(100% - 3rem); /* p-6 is 1.5rem on each side */
        }

        /* Staggered list animation */
        @keyframes slide-in-up {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-slide-in-up {
            animation: slide-in-up 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            opacity: 0;
        }
    </style>
</head>
<body class="antialiased bg-gray-100 text-gray-800">

    <div id="app-container">
        <div class="flex flex-col md:flex-row h-screen">
            <!-- Sidebar -->
            <aside class="w-full md:w-1/3 lg:w-1/4 bg-gray-900 text-gray-300 shadow-2xl flex flex-col">
                <div class="p-6 border-b border-gray-700/50">
                    <h1 class="text-2xl text-white tracking-wider">SF Map</h1>
                    <p class="text-sm text-gray-400">Developed by Rochak Kadel</p>
                </div>
                
                <div class="flex-grow p-6 overflow-y-auto custom-scrollbar relative">
                    <!-- View for initial button -->
                    <div id="initial-view" class="view-panel">
                        <button id="show-relief-routes-btn" class="w-full text-center p-4 bg-white text-gray-900 rounded-lg shadow-md hover:bg-gray-200 focus:outline-none focus:ring-2 ring-offset-2 ring-offset-gray-900 focus:ring-gray-400 transition-all duration-200 transform hover:scale-105 active:scale-100">
                            Break Reliefs routes
                        </button>
                    </div>

                    <!-- View for relief employee list -->
                    <div id="relief-list-view" class="view-panel hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl text-white">Relief Staff</h2>
                            <button id="back-to-initial-btn" class="text-sm text-blue-400 hover:text-blue-300 transition">Back</button>
                        </div>
                        <div id="relief-employee-list" class="space-y-3">
                            <!-- Employee buttons will be injected here -->
                        </div>
                    </div>

                    <!-- Selected Route Information Section -->
                    <div id="route-info-section" class="view-panel hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h3 id="route-employee-name" class="text-xl text-white"></h3>
                            <button id="back-to-relief-list-btn" class="text-sm text-blue-400 hover:text-blue-300 transition">Back</button>
                        </div>
                        <div id="route-schedule" class="space-y-3">
                            <!-- Schedule details will be injected here -->
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Map container -->
            <main class="w-full md:w-2/3 lg:w-3/4 relative">
                <div id="map"></div>
                <!-- Legends Container -->
                <div id="legends-container" class="absolute top-4 right-4 space-y-3 z-[1000]">
                     <!-- Manager Legend -->
                    <div id="manager-legend-container" class="bg-gray-900/70 backdrop-blur-sm text-gray-200 p-4 rounded-lg shadow-lg transition-opacity duration-300 border border-gray-700/50">
                        <div id="manager-legend" class="space-y-2">
                            <!-- Legend items will be injected here by JavaScript -->
                        </div>
                    </div>

                    <!-- Relief Site Legend -->
                    <div id="relief-legend-container" class="bg-gray-900/70 backdrop-blur-sm text-gray-200 p-4 rounded-lg shadow-lg transition-opacity duration-300 hidden max-h-[70vh] overflow-y-auto custom-scrollbar border border-gray-700/50">
                        <div id="relief-legend-list" class="space-y-2">
                            <!-- Relief site legend items will be injected here -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- DATA STRUCTURES --- //
        const managerColors = {
            "Doug Fletcher": "#3b82f6", // Blue
            "Jason Daugherty": "#f97316", // Orange
            "Aldo Diaz": "#22c55e", // Green
            "Mohamed Ezzat": "#ef4444", // Red
            "Inderprit Gill": "#8b5cf6"  // Violet
        };

        const sites = {
            "Doug Fletcher": [
                { name: "The Contemporary Jewish Museum", address: "736 Mission St", lat: 37.7857, lng: -122.4042 },
                { name: "JLL - 600 California St", address: "600 California St", lat: 37.7925, lng: -122.4024 },
                { name: "JLL - 120 Kearny St (PMC)", address: "120 Kearny St", lat: 37.7892, lng: -122.4040 }
            ],
            "Jason Daugherty": [
                { name: "CBRE - 1128 Market St", address: "1128 Market St", lat: 37.7788, lng: -122.4132 },
                { name: "The Potrero Power Station", address: "420 23rd St", lat: 37.7570, lng: -122.3850 },
                { name: "Sutro Tower, Inc", address: "1 La Avanzada St", lat: 37.7552, lng: -122.4528 },
                { name: "CBRE - 500 Howard St", address: "500 Howard St", lat: 37.7876, lng: -122.3958 },
                { name: "CBRE - 500 Pine", address: "500 Pine St", lat: 37.7915, lng: -122.4029 },
                { name: "AJ Capital Partners", address: "1800 Mission St", lat: 37.7675, lng: -122.4196 },
                { name: "Dalum Corporation", address: "130 Battery St", lat: 37.7942, lng: -122.3992 },
                { name: "Sequoias", address: "1400 Geary Blvd", lat: 37.7852, lng: -122.4300 },
                { name: "JLL - 300 Kansas St", address: "300 Kansas St", lat: 37.7676, lng: -122.4045 },
                { name: "Swig - 633 Folsom St", address: "633 Folsom St", lat: 37.7836, lng: -122.3973 },
                { name: "Swig - 501 2nd St", address: "501 2nd St", lat: 37.7845, lng: -122.3912 },
                { name: "Doublewood Investment", address: "111 Pine St", lat: 37.7932, lng: -122.4000 },
                { name: "Novva", address: "400 Paul Ave", lat: 37.7228, lng: -122.4209 },
                { name: "633 Folsom", address: "633 Folsom St", lat: 37.7836, lng: -122.3973 },
                { name: "1 Kearny", address: "1 Kearny St", lat: 37.7877, lng: -122.4043 },
                { name: "1200 Van Ness", address: "1200 Van Ness Ave", lat: 37.7865, lng: -122.4217 }
            ],
            "Aldo Diaz": [
                { name: "181 Fremont Street", address: "181 Fremont St", lat: 37.7895, lng: -122.3950 },
                { name: "Harvest - 274 Brannan St", address: "274 Brannan St", lat: 37.7820, lng: -122.3908 },
                { name: "Harvest - 360 Spear St", address: "360 Spear St", lat: 37.7861, lng: -122.3908 },
                { name: "Tavaco - 1035 Market St", address: "1035 Market St", lat: 37.7806, lng: -122.4105 },
                { name: "JLL - 150 Spear St", address: "150 Spear St", lat: 37.7909, lng: -122.3941 },
                { name: "RREG - 750 Battery Corp.", address: "750 Battery St", lat: 37.7984, lng: -122.4011 },
                { name: "Tusker Corporation", address: "1635 Divisadero St", lat: 37.7844, lng: -122.4400 },
                { name: "Van Barton - 115 Sansome", address: "115 Sansome St", lat: 37.7920, lng: -122.4010 },
                { name: "CBRE - 180 Montgomery", address: "180 Montgomery St", lat: 37.7895, lng: -122.4030 },
                { name: "Swig - 220 Montgomery St", address: "220 Montgomery St", lat: 37.7901, lng: -122.4027 },
                { name: "ECP - 601 California St", address: "601 California St", lat: 37.7925, lng: -122.4032 },
                { name: "EPA - 711 Eddy St", address: "711 Eddy St", lat: 37.7828, lng: -122.4208 },
                { name: "WPA - 1280 Laguna", address: "1280 Laguna St", lat: 37.7849, lng: -122.4293 },
                { name: "CW - 71 Stevenson St", address: "71 Stevenson St", lat: 37.7885, lng: -122.3995 }
            ],
            "Mohamed Ezzat": [
                { name: "Colliers - 153 Kearny St", address: "153 Kearny St", lat: 37.7896, lng: -122.4042 },
                { name: "JLL - 110 Sutter", address: "110 Sutter St", lat: 37.7903, lng: -122.4037 },
                { name: "Colliers - 240 Stockton St", address: "240 Stockton St", lat: 37.7881, lng: -122.4069 },
                { name: "Colliers - 26 O'Farrell St", address: "26 O'Farrell St", lat: 37.7871, lng: -122.4065 },
                { name: "G&G Partners", address: "30 Grant Ave", lat: 37.7877, lng: -122.4055 },
                { name: "YCS Investments", address: "170 Maiden Lane", lat: 37.7885, lng: -122.4053 },
                { name: "Olympic Club Lakeside", address: "599 Skyline Blvd", lat: 37.7214, lng: -122.4960 },
                { name: "CW - 456 Montgomery St", address: "456 Montgomery St", lat: 37.7927, lng: -122.4031 },
                { name: "Colliers - 717 Market St", address: "717 Market St", lat: 37.7869, lng: -122.4039 },
                { name: "JLL - 201 Mission St", address: "201 Mission St", lat: 37.7915, lng: -122.3947 },
                { name: "Van Barton - 101 Mission", address: "101 Mission St", lat: 37.7927, lng: -122.3951 },
                { name: "Van Barton - 100 Montgomery", address: "100 Montgomery St", lat: 37.7890, lng: -122.4032 },
                { name: "Colliers - 166 Geary", address: "166 Geary St", lat: 37.7883, lng: -122.4061 }
            ],
            "Inderprit Gill": [
                { name: "Seligman - 311 California St", address: "311 California St", lat: 37.7931, lng: -122.4005 },
                { name: "JKL Corporation", address: "90 New Montgomery St", lat: 37.7869, lng: -122.4009 },
                { name: "Seligman - 785 Market St", address: "785 Market St", lat: 37.7860, lng: -122.4047 },
                { name: "Metrovation", address: "230 California St", lat: 37.7937, lng: -122.3991 },
                { name: "JLL - 101 Montgomery St", address: "101 Montgomery St", lat: 37.7890, lng: -122.4032 },
                { name: "JLL - 425 California St", address: "425 California St", lat: 37.7935, lng: -122.4019 },
                { name: "Transwestern - 210 Post St", address: "210 Post St", lat: 37.7887, lng: -122.4063 },
                { name: "Seaker & Sons", address: "30 Maiden Lane", lat: 37.7880, lng: -122.4057 },
                { name: "Flynn Properties", address: "222 Kearny St", lat: 37.7903, lng: -122.4043 },
                { name: "TMG LLC - 150 Post St", address: "150 Post St", lat: 37.7891, lng: -122.4054 },
                { name: "Transwestern - 1019 Market St", address: "1019 Market St", lat: 37.7812, lng: -122.4100 },
                { name: "CW - 425 Market St", address: "425 Market St", lat: 37.7920, lng: -122.3971 }
            ]
        };
        
        const breakReliefs = {
            "Yolanda Perez": {
                schedule: [
                    { locationName: "90 New Montgomery St", startTime: "8:30", endTime: "8:45" },
                    { locationName: "71 Stevenson St", startTime: "8:50", endTime: "9:05" },
                    { locationName: "30 Grant Ave", startTime: "9:15", endTime: "9:30" },
                    { locationName: "Break", startTime: "9:30", endTime: "10:00", isBreak: true },
                    { locationName: "1019 Market St", startTime: "10:00", endTime: "10:15" },
                    { locationName: "90 New Montgomery St", startTime: "10:45", endTime: "11:00" },
                    { locationName: "30 Grant Ave", startTime: "11:15", endTime: "11:45" },
                    { locationName: "71 Stevenson St", startTime: "12:00", endTime: "12:15" },
                    { locationName: "1019 Market St", startTime: "12:45", endTime: "13:00" },
                    { locationName: "30 Grant Ave", startTime: "13:15", endTime: "13:30" }
                ]
            },
             "Apithany Hayes": { 
                schedule: [
                    { locationName: "101 Montgomery St", startTime: "9:00", endTime: "9:15" },
                    { locationName: "425 California St", startTime: "9:25", endTime: "9:40" },
                    { locationName: "153 Kearny St", startTime: "9:50", endTime: "10:05" },
                    { locationName: "Break", startTime: "10:05", endTime: "10:20", isBreak: true },
                    { locationName: "101 Montgomery St", startTime: "10:45", endTime: "11:15" },
                    { locationName: "425 California St", startTime: "11:25", endTime: "11:55" },
                    { locationName: "153 Kearny St", startTime: "12:05", endTime: "12:35" },
                    { locationName: "150 Post St", startTime: "12:40", endTime: "13:40" },
                    { locationName: "Lunch", startTime: "13:45", endTime: "14:15", isBreak: true },
                    { locationName: "101 Montgomery St", startTime: "14:15", endTime: "14:30" },
                    { locationName: "425 California St", startTime: "14:40", endTime: "14:55" },
                    { locationName: "153 Kearny St", startTime: "15:05", endTime: "15:20" }
                ]
            },
            "Imran Anwar": {
                schedule: [
                    { locationName: "210 Post St", startTime: "9:00", endTime: "9:15" },
                    { locationName: "30 Maiden Lane", startTime: "9:30", endTime: "9:45" },
                    { locationName: "Break", startTime: "9:45", endTime: "10:15", isBreak: true },
                    { locationName: "210 Post St", startTime: "10:15", endTime: "10:45" },
                    { locationName: "111 Pine St", startTime: "11:00", endTime: "11:30" },
                    { locationName: "30 Maiden Lane", startTime: "11:45", endTime: "12:15" },
                    { locationName: "210 Post St", startTime: "12:30", endTime: "12:45" },
                    { locationName: "30 Maiden Lane", startTime: "13:00", endTime: "13:15" }
                ]
            },
            "Eli Walin": {
                schedule: [
                    { locationName: "750 Battery St", startTime: "9:00", endTime: "9:15" },
                    { locationName: "222 Kearny St", startTime: "9:35", endTime: "9:50" },
                    { locationName: "Break", startTime: "9:50", endTime: "10:45", isBreak: true },
                    { locationName: "750 Battery St", startTime: "10:45", endTime: "11:15" },
                    { locationName: "222 Kearny St", startTime: "11:45", endTime: "12:15" },
                    { locationName: "750 Battery St", startTime: "12:35", endTime: "12:50" },
                    { locationName: "222 Kearny St", startTime: "13:15", endTime: "13:30" },
                    { locationName: "230 California St", startTime: "15:00", endTime: "19:00" }
                ]
            },
            "Melaysia Horn": {
                schedule: [
                    { locationName: "101 Mission", startTime: "8:30", endTime: "8:45" },
                    { locationName: "110 Sutter", startTime: "9:00", endTime: "9:15" },
                    { locationName: "26 O'Farrell St", startTime: "9:25", endTime: "9:40" },
                    { locationName: "101 Mission", startTime: "10:30", endTime: "11:00" },
                    { locationName: "110 Sutter", startTime: "11:15", endTime: "11:45" },
                    { locationName: "26 O'Farrell St", startTime: "11:55", endTime: "12:25" },
                    { locationName: "Lunch", startTime: "12:25", endTime: "13:00", isBreak: true },
                    { locationName: "101 Mission", startTime: "13:00", endTime: "13:15" },
                    { locationName: "110 Sutter", startTime: "13:30", endTime: "13:45" },
                    { locationName: "1 Kearny", startTime: "13:55", endTime: "14:25" },
                    { locationName: "26 O'Farrell St", startTime: "14:30", endTime: "14:45" }
                ]
            },
            "Adham Shaef": {
                schedule: [
                    { locationName: "115 Sansome", startTime: "7:00", endTime: "7:15" },
                    { locationName: "240 Stockton St", startTime: "7:30", endTime: "7:45" },
                    { locationName: "717 Market St", startTime: "8:00", endTime: "8:15" },
                    { locationName: "500 Pine", startTime: "8:30", endTime: "8:45" },
                    { locationName: "Lunch", startTime: "8:45", endTime: "9:15", isBreak: true },
                    { locationName: "115 Sansome", startTime: "9:15", endTime: "9:45" },
                    { locationName: "240 Stockton St", startTime: "10:00", endTime: "10:30" },
                    { locationName: "717 Market St", startTime: "10:40", endTime: "11:10" },
                    { locationName: "500 Pine", startTime: "11:25", endTime: "11:55" },
                    { locationName: "Break", startTime: "11:55", endTime: "12:25", isBreak: true },
                    { locationName: "115 Sansome", startTime: "12:25", endTime: "12:40" },
                    { locationName: "240 Stockton St", startTime: "12:55", endTime: "13:10" },
                    { locationName: "500 Pine", startTime: "13:20", endTime: "13:35" },
                    { locationName: "717 Market St", startTime: "13:45", endTime: "14:00" }
                ]
            }
        };

        // --- MAP INITIALIZATION & LOGIC --- //
        let mapInitialized = false;

        const relieverColors = {
            "Adham Shaef": "#8e44ad",   // Purple
            "Apithany Hayes": "#27ae60", // Green
            "Eli Walin": "#2980b9",     // Blue
            "Imran Anwar": "#f39c12",   // Orange
            "Melaysia Horn": "#c0392b", // Red
            "Yolanda Perez": "#00bcd4"  // Cyan
        };

        function initializeMapApplication() {
            if (mapInitialized) return;

            const map = L.map('map').setView([37.7749, -122.4194], 13);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            const allSitesLayer = L.layerGroup().addTo(map);
            const routeLayer = L.layerGroup().addTo(map);

            const managerLegend = document.getElementById('manager-legend-container');
            const reliefLegend = document.getElementById('relief-legend-container');

            const allSitesList = Object.values(sites).flat();

            function findSiteByAddress(address) {
                const normalizedSearch = address.toLowerCase().trim();
                let foundSite = allSitesList.find(site => site.address.toLowerCase().trim().startsWith(normalizedSearch));
                if (!foundSite) {
                    foundSite = allSitesList.find(site => site.name.toLowerCase().includes(normalizedSearch));
                }
                return foundSite;
            }
            
            function createColoredIcon(color, options = {}) {
                const { opacity = 1.0, scale = 1.0 } = options;
                const size = 32 * scale;
                const iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${color}" width="${size}px" height="${size}px" style="opacity: ${opacity}; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>`;
                return L.divIcon({ html: iconHtml, className: '', iconSize: [size, size], iconAnchor: [size / 2, size], popupAnchor: [0, -size] });
            }
            
            function displayAllSites() {
                allSitesLayer.clearLayers();
                routeLayer.clearLayers();
                managerLegend.style.opacity = 1;
                reliefLegend.classList.add('hidden');
                Object.entries(sites).forEach(([manager, locations]) => {
                    const color = managerColors[manager] || '#3388ff';
                    const icon = createColoredIcon(color);
                    locations.forEach(site => {
                        const marker = L.marker([site.lat, site.lng], { icon: icon }).addTo(allSitesLayer);
                        marker.bindPopup(`<b>${site.name}</b><br>${site.address}<br><small>Manager: ${manager}</small>`);
                    });
                });
            }

            function displayOnlyReliefSites() {
                routeLayer.clearLayers();
                allSitesLayer.clearLayers();
                managerLegend.style.opacity = 0;
                reliefLegend.classList.remove('hidden');

                const reliefLegendList = document.getElementById('relief-legend-list');
                reliefLegendList.innerHTML = '';
                Object.keys(relieverColors).sort().forEach(relieverName => {
                    const color = relieverColors[relieverName];
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center space-x-3 animate-slide-in-up';
                    legendItem.style.animationDelay = `${Object.keys(relieverColors).sort().indexOf(relieverName) * 50}ms`;
                    legendItem.innerHTML = `
                        <div class="w-4 h-4 rounded-full flex-shrink-0" style="background-color: ${color};"></div>
                        <span class="text-sm text-gray-200">${relieverName}</span>
                    `;
                    reliefLegendList.appendChild(legendItem);
                });

                const siteToRelieversMap = new Map();
                Object.entries(breakReliefs).forEach(([relieverName, relief]) => {
                    relief.schedule.forEach(item => {
                        if (!item.isBreak) {
                            const site = findSiteByAddress(item.locationName);
                            if (site) {
                                if (!siteToRelieversMap.has(site.name)) {
                                    siteToRelieversMap.set(site.name, { site: site, relievers: new Set() });
                                }
                                siteToRelieversMap.get(site.name).relievers.add(relieverName);
                            }
                        }
                    });
                });

                const reliefBounds = [];
                siteToRelieversMap.forEach(({ site, relievers }) => {
                    const relieverList = Array.from(relievers);
                    const color = relieverColors[relieverList[0]] || '#3388ff';
                    const popupText = `Reliever: ${relieverList.join(', ')}`;

                    const icon = createColoredIcon(color, { scale: 0.9 });
                    const marker = L.marker([site.lat, site.lng], { icon: icon }).addTo(allSitesLayer);
                    marker.bindPopup(`<b>${site.name}</b><br>${site.address}<br><small>${popupText}</small>`);
                    reliefBounds.push([site.lat, site.lng]);
                });

                if (reliefBounds.length > 0) {
                    map.fitBounds(reliefBounds, { padding: [50, 50] });
                }
            }

            function displayRoute(employeeName) {
                routeLayer.clearLayers();
                allSitesLayer.clearLayers();
                managerLegend.style.opacity = 0;
                reliefLegend.classList.add('hidden');
                
                const relief = breakReliefs[employeeName];

                if (!relief) return;

                const routePoints = [];
                const aggregatedStops = {};
                let stopCounter = 1;

                const scheduleContainer = document.getElementById('route-schedule');
                scheduleContainer.innerHTML = '';
                
                relief.schedule.forEach((item, index) => {
                    const scheduleItemDiv = document.createElement('div');
                    scheduleItemDiv.className = 'animate-slide-in-up';
                    scheduleItemDiv.style.animationDelay = `${index * 50}ms`;
                    
                    if (item.isBreak) {
                        scheduleItemDiv.classList.add('p-3', 'rounded-lg', 'bg-gray-800/50');
                        scheduleItemDiv.innerHTML = `
                            <div class="text-amber-400">${item.locationName}</div>
                            ${item.startTime ? `<div class="text-sm text-gray-400">${item.startTime} - ${item.endTime}</div>` : ''}
                        `;
                    } else {
                        scheduleItemDiv.classList.add('p-3', 'rounded-lg', 'bg-gray-700/50', 'border', 'border-gray-600/50');
                        const site = findSiteByAddress(item.locationName);
                        if (site) {
                            scheduleItemDiv.innerHTML = `
                                <div class="text-white"><span class="text-gray-400">${stopCounter}.</span> ${site.name}</div>
                                <div class="text-sm text-gray-400 pl-4">${item.startTime} - ${item.endTime}</div>
                                <div class="text-xs text-gray-500 pl-4">${site.address}</div>
                            `;
                            routePoints.push([site.lat, site.lng]);
                            
                            const key = `${site.lat},${site.lng}`;
                            if (!aggregatedStops[key]) {
                                aggregatedStops[key] = { lat: site.lat, lng: site.lng, name: site.name, stopNums: [] };
                            }
                            aggregatedStops[key].stopNums.push(stopCounter);
                        } else {
                             scheduleItemDiv.innerHTML = `
                                <div class="text-red-400">${stopCounter}. Location not found</div>
                                <div class="text-sm text-red-500">${item.locationName}</div>`;
                        }
                        stopCounter++;
                    }
                    scheduleContainer.appendChild(scheduleItemDiv);
                });
                
                if (routePoints.length > 1) {
                    L.polyline(routePoints, { color: relieverColors[employeeName] || '#3388ff', weight: 4, opacity: 0.8 }).addTo(routeLayer);
                }

                Object.values(aggregatedStops).forEach(stop => {
                    const stopNumbersText = stop.stopNums.join(',');
                    const iconWidth = 10 * stopNumbersText.length + 20;
                    
                    const siteColor = relieverColors[employeeName];
                    if (siteColor) {
                        const bgIcon = createColoredIcon(siteColor, { opacity: 0.8, scale: 1.1 });
                        L.marker([stop.lat, stop.lng], { icon: bgIcon }).addTo(routeLayer);
                    }

                    const numberIcon = L.divIcon({ 
                        className: 'route-marker-icon', 
                        html: `<span>${stopNumbersText}</span>`, 
                        iconSize: [iconWidth, 28], 
                        iconAnchor: [iconWidth / 2, 14] 
                    });
                    L.marker([stop.lat, stop.lng], { icon: numberIcon, zIndexOffset: 1000 })
                        .bindPopup(`<b>Stops ${stopNumbersText}: ${stop.name}</b>`)
                        .addTo(routeLayer);
                });
                
                if (routePoints.length > 0) {
                    map.fitBounds(routePoints, { padding: [50, 50] });
                }

                document.getElementById('route-employee-name').textContent = `${employeeName}'s Route`;
                
                switchView(routeInfoSection);
            }
            
            // Populate Manager Legend
            const legendContainer = document.getElementById('manager-legend');
            Object.keys(managerColors).sort().forEach((name, index) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'flex items-center space-x-3 animate-slide-in-up';
                legendItem.style.animationDelay = `${index * 50}ms`;
                legendItem.innerHTML = `
                    <div class="w-4 h-4 rounded-full flex-shrink-0" style="background-color: ${managerColors[name]};"></div>
                    <span class="text-sm text-gray-200">${name}</span>`;
                legendContainer.appendChild(legendItem);
            });

            // Populate relief employee list
            const employeeListContainer = document.getElementById('relief-employee-list');
            Object.keys(breakReliefs).sort().forEach((name, index) => {
                const button = document.createElement('button');
                button.textContent = name;
                button.className = 'w-full text-left p-3 bg-white text-gray-900 rounded-lg hover:bg-gray-200 transition-colors duration-200 transform hover:translate-x-1 animate-slide-in-up';
                button.style.animationDelay = `${index * 50}ms`;
                button.onclick = () => displayRoute(name);
                employeeListContainer.appendChild(button);
            });

            // UI Views & State
            const initialView = document.getElementById('initial-view');
            const reliefListView = document.getElementById('relief-list-view');
            const routeInfoSection = document.getElementById('route-info-section');
            const allViews = [initialView, reliefListView, routeInfoSection];

            function switchView(targetView) {
                allViews.forEach(view => {
                    if (view !== targetView) {
                        view.classList.add('hidden');
                    }
                });
                targetView.classList.remove('hidden');
            }
            
            // Event Listeners
            document.getElementById('show-relief-routes-btn').addEventListener('click', () => {
                switchView(reliefListView);
                displayOnlyReliefSites();
            });
            document.getElementById('back-to-initial-btn').addEventListener('click', () => {
                switchView(initialView);
                displayAllSites();
                map.setView([37.7749, -122.4194], 13);
            });
            document.getElementById('back-to-relief-list-btn').addEventListener('click', () => {
                switchView(reliefListView);
                displayOnlyReliefSites();
            });
            
            // Initial State
            displayAllSites();
            mapInitialized = true;
        }

        document.addEventListener('DOMContentLoaded', initializeMapApplication);
    </script>
</body>
</html>

